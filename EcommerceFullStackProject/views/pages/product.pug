extends ../layout

block content
  if product
    - const ratingValue = Number(product.rating || 0)
    - const reviewCount = Number(product.reviewCount || 0)
    - const safeReviewCount = reviewCount > 0 ? reviewCount : 128
    - const colorList = product.colors && product.colors.length ? product.colors : ['#111827', '#2563eb', '#f8fafc']
    - const priceValue = Number(product.price || 0)
    - const originalValue = Number(product.originalPrice || 0)
    - const hasDiscount = originalValue > priceValue && originalValue > 0
    - const discountPct = hasDiscount ? Math.round(((originalValue - priceValue) / originalValue) * 100) : 0
    - const roundedRating = Math.max(0, Math.min(5, Math.round(ratingValue)))
    .container.product-detail
      .product-detail-grid
        .product-images
          .product-media.product-detail-media
            if product.image && product.image.length > 0
              img(src=imageUrl(product.image), alt=product.name)
            else
              span.no-image []

          if product.highlights && product.highlights.length
            .card
              h3 Quick Highlights
              ul.info-list
                each item in product.highlights
                  li= item

        .product-info
          .product-header
            h1= product.name
            if product.category
              span.badge.badge-surface= product.category

          .product-rating.large
            span.rating-stars= '★★★★★'.slice(0, roundedRating) + '☆☆☆☆☆'.slice(0, 5 - roundedRating)
            span.rating-count #{ratingValue.toFixed(1)} (#{safeReviewCount} reviews)

          .price-row.large
            span.price-current $#{priceValue.toFixed(2)}
            if hasDiscount
              span.price-original $#{originalValue.toFixed(2)}
              span.price-discount Save #{discountPct}%

          .card
            h3 Color Options
            .swatch-row
              each color in colorList
                span.swatch(style=`--swatch:${color}` title=color)

          if product.description
            .card
              h3 Description
              p= product.description

          .card
            if product.inStock !== false
              p.stock-note In stock
              if product.stock
                p.product-meta #{product.stock} units available
            else
              p.stock-note.out Out of stock

          if !user || user.role !== 'admin'
            form.product-form(action="/cart/add" method="POST")
              input(type="hidden" name="productId" value=product._id)
              button.btn(type="submit") Add to Cart
