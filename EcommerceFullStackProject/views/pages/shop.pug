extends ../layout

block content
  section.hero
    .hero-inner(style="flex-direction: column; text-align: center;")
      .hero-left(style="flex: none;")
        h1.hero-title Shop Our Collection
        p.hero-sub Discover thousands of products from top brands at unbeatable prices.

  .container
    nav.breadcrumbs
      a(href="/") Home
      span.sep /
      span Shop
    .card.filter-card
      h3 Filter Products
      form.shop-filters(action="/shop" method="GET")
        .filter-grid
          .form-group
            label(for="q") Semantic Search
            input#q(type="text" name="q" placeholder="e.g. black running shoes under 50" value=q || '')
          .form-group
            label(for="sort") Sort By
            select#sort(name="sort")
              option(value="") Default
              option(value="price_asc", selected=(sort === 'price_asc')) Price: Low to High
              option(value="price_desc", selected=(sort === 'price_desc')) Price: High to Low
              option(value="rating", selected=(sort === 'rating')) Top Rated
              option(value="newest", selected=(sort === 'newest')) Newest
          .form-group
            label(for="category") Category
            select#category(name="category")
              option(value="") All Categories
              each c in categories
                option(value=c, selected=(c === selectedCategory))= c
          .form-group
            label(for="minPrice") Minimum Price
            input#minPrice(type="number" name="minPrice" placeholder="$0" value=minPrice || '')
          .form-group
            label(for="maxPrice") Maximum Price
            input#maxPrice(type="number" name="maxPrice" placeholder="$1000" value=maxPrice || '')
          .field-btn
            button.btn(type="submit") Apply Filters
            a.btn.btn-outline(href="/shop") Reset All

  .container
    if aiError
      .card
        p.text-danger Semantic search is unavailable, showing standard results.
    if !products || products.length === 0
      .card
        .text-center
          p(style="font-size: 2rem; margin-bottom: 1rem;") Search
          h3 No Products Found
          p(style="color: var(--muted);") Try adjusting your filters or browse all products.
          a.btn(href="/shop") Browse All Products
    else
      .section-head
        h2 Results (#{products.length} product#{products.length !== 1 ? 's' : ''})
        if totalPages && totalPages > 1
          span.text-muted Page #{currentPage} of #{totalPages}

      .products-grid
        each p in products
          - const ratingValue = Number(p.rating || 0)
          - const reviewCount = Number(p.reviewCount || 0)
          - const safeReviewCount = reviewCount > 0 ? reviewCount : 128
          - const colorList = p.colors && p.colors.length ? p.colors : ['#111827', '#2563eb', '#f8fafc']
          - const priceValue = Number(p.price || 0)
          - const originalValue = Number(p.originalPrice || 0)
          - const hasDiscount = originalValue > priceValue && originalValue > 0
          - const discountPct = hasDiscount ? Math.round(((originalValue - priceValue) / originalValue) * 100) : 0
          - const roundedRating = Math.max(0, Math.min(5, Math.round(ratingValue)))
          - const isAvailable = p.inStock !== false && Number(p.stock || 0) > 0
          - const deliveryText = isAvailable ? 'Ships in 24-48 hrs' : 'Restock soon'
          .product
            .product-media
              if p.image && p.image.length > 0
                img(src=imageUrl(p.image), alt=p.name, loading="lazy", decoding="async")
              else
                span.no-image []

              if p.category
                span.badge.badge-surface= p.category
              if isAvailable
                span.badge.badge-trust Free Returns
              if !isAvailable
                span.badge.badge-danger Out of stock

            .product-body
              .product-top
                .product-colors
                  each color, idx in colorList.slice(0, 4)
                    span.swatch(style=`--swatch:${color}`)
                  if colorList.length > 4
                    span.swatch.more +#{colorList.length - 4}

                .product-rating
                  span.rating-stars= '★★★★★'.slice(0, roundedRating) + '☆☆☆☆☆'.slice(0, 5 - roundedRating)
                  span.rating-count (#{safeReviewCount})

              h3= p.name

              .price-row
                span.price-current $#{priceValue.toFixed(2)}
                if hasDiscount
                  span.price-original $#{originalValue.toFixed(2)}
                  span.price-discount -#{discountPct}%

              p.product-meta= deliveryText
              if p.stock
                p.product-meta Stock: #{p.stock}

              .product-actions
                a.btn.btn-outline(href=`/product/${p._id}`) View Details
                if !user || user.role !== 'admin'
                  if isAvailable
                    form(action="/cart/add" method="POST" style="margin: 0;")
                      input(type="hidden" name="productId" value=p._id)
                      .quick-add
                        input(type="number" name="quantity" min="1" max=p.stock value="1")
                        button.btn(type="submit") Add
                  else
                    button.btn(type="button" style="width: 100%;" disabled) Out of Stock

  if totalPages && totalPages > 1
    .container
      .pagination-bar
        span.text-muted Page #{currentPage} of #{totalPages}
        .pagination-links
          if currentPage > 1
            a.btn.btn-outline(href=`/shop?page=${currentPage-1}&q=${q||''}&sort=${sort||''}&category=${selectedCategory||''}&minPrice=${minPrice||''}&maxPrice=${maxPrice||''}`) <- Previous
          if currentPage < totalPages
            a.btn(href=`/shop?page=${currentPage+1}&q=${q||''}&sort=${sort||''}&category=${selectedCategory||''}&minPrice=${minPrice||''}&maxPrice=${maxPrice||''}`) Next ->
